generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "foreignKeys"
}

enum Status {
  active
  inactive
  pending
}

enum ReviewTargetType {
  DOCTOR
  CLINIC
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum UserRole {
  ADMIN
  CLINIC
  DOCTOR
  PATIENT
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  PENDING
  RESCHEDULED
}

//***************
//**********************
//   {model }
//************************
//*********************

model User {
  id   String @id @default(cuid())
  name String

  // ফোন নম্বরই এখন একমাত্র ইউনিক আইডেন্টিফায়ার
  phoneNumber       String    @unique
  isPhoneVerified   Boolean   @default(false)
  // OTP ভেরিফিকেশন ফিল্ডস
  otp               String?
  otpExpires        DateTime?
  isDefaultPassword Boolean   @default(false)
  image             String?
  password          String
  refreshToken      String?
  role              UserRole  @default(PATIENT)
  lastLoginAt       DateTime?
  deactivate        Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // রিলেশনশিপসমূহ
  doctor                Doctor?
  patient               Patient?
  clinic                Clinic?
  favoriteDoctors       FavoriteDoctor[]
  reviewsWritten        Review[]         @relation("UserReviewsWritten")
  reviewsReceived       Review[]         @relation("UserReviewsReceived")
  reviewReplies         ReviewReply[]    @relation("UserRepliesMade")
  appointmentsAsDoctor  Appointment[]    @relation("DoctorAppointments")
  appointmentsAsPatient Appointment[]    @relation("PatientAppointments")
  appointmentsAsClinic  Appointment[]    @relation("ClinicAppointments")
  deviceTokens          DeviceToken[]

  // ইনডেক্সিং (সার্চিং ফাস্ট করার জন্য)
  @@index([phoneNumber])
}

model Otp {
  phoneNumber String   @unique
  otp         String
  otpExpires  DateTime

  @@index([otp, phoneNumber])
}

model Doctor {
  id             String       @id @default(cuid())
  userId         String       @unique
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  slug           String       @unique
  department     String
  specialization String?
  bio            String?      @db.Text
  gender         Gender?
  website        String?
  position       String?
  address        String?
  district       String?
  city           String?
  active         Boolean      @default(true)
  country        String       @default("Bangladesh")
  education      Json?
  hospital       String?      @db.Text
  degree         String?      @db.Text
  averageRating  Float        @default(0.0)
  reviewsCount   Int          @default(0)
  memberships    Membership[]

  favoriteDoctors FavoriteDoctor[]
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  searchVector    Unsupported("tsvector")? @map("search_vector")

  @@index([slug])
  @@index([city])
  @@index([district])
  @@index([department])
  @@index([specialization])
  @@index([averageRating(sort: Desc)])
  @@index([searchVector], type: Gin)
}

model Patient {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  slug        String   @unique
  age         Int?
  gender      Gender   @default(MALE)
  bloodGroup  String?
  phoneNumber String?
  address     String?
  district    String?
  city        String?
  country     String   @default("Bangladesh")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  favoriteDoctors FavoriteDoctor[]

  @@index([phoneNumber])
}

model Clinic {
  id              String       @id @default(cuid())
  userId          String       @unique
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  slug            String       @unique
  phoneNumber     String?
  description     String?      @db.Text
  averageRating   Float        @default(0.0)
  reviewsCount    Int          @default(0)
  openingHour     String?
  website         String?      @db.Text
  active          Boolean      @default(true)
  establishedYear Int?
  address         String?
  district        String?
  city            String?
  country         String       @default("Bangladesh")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  memberships     Membership[]

  @@index([slug])
  @@index([city])
  @@index([district])
  @@index([averageRating])
}

model Membership {
  id              String     @id @default(cuid())
  doctorId        String
  clinicId        String
  fee             String
  active          Boolean    @default(true)
  maxAppointments String
  discount        String
  expiresAt       DateTime   @default(now())
  doctor          Doctor     @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  clinic          Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  schedules       Schedule[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@unique([doctorId, clinicId])
  @@index([clinicId])
  @@index([doctorId])
}

model Schedule {
  id           String     @id @default(cuid())
  membershipId String
  membership   Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  days         String[]
  times        String
  note         String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([membershipId, days])
  @@index([membershipId])
}

model Appointment {
  id              String            @id @default(cuid())
  patientName     String
  ptAge           String
  phoneNumber     String
  address         String?
  note            String?
  appointmentDate DateTime
  times           String?
  serialNumber    String?
  code            String?
  status          AppointmentStatus @default(SCHEDULED)
  doctorId        String
  doctor          User              @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade)
  patientId       String
  patient         User              @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade)
  clinicId        String
  clinic          User              @relation("ClinicAppointments", fields: [clinicId], references: [id], onDelete: Cascade)
  medicalRecords  MedicalRecord[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([doctorId, appointmentDate])
  @@index([patientId, appointmentDate])
}

model MedicalRecord {
  id            String      @id @default(cuid())
  name          String
  description   String?     @db.Text
  date          DateTime    @default(now())
  document      String?
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([appointmentId])
}

model Review {
  id         String           @id @default(cuid())
  targetId   String
  target     User             @relation("UserReviewsReceived", fields: [targetId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer   User             @relation("UserReviewsWritten", fields: [reviewerId], references: [id], onDelete: Cascade)
  targetType ReviewTargetType
  rating     Int              @default(1)
  comment    String?          @db.Text
  status     ReviewStatus     @default(PENDING)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  reviewReply ReviewReply?

  // 
  @@unique([reviewerId, targetId])
  @@index([targetId])
}

model ReviewReply {
  id       String @id @default(cuid())
  content  String @db.Text
  reviewId String @unique
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Link to User (The Doctor or Clinic replying)
  repliedById String
  repliedBy   User   @relation("UserRepliesMade", fields: [repliedById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reviewId])
}

model FavoriteDoctor {
  id        String   @id @default(cuid())
  userId    String
  doctorId  String
  patientId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient   Patient  @relation(fields: [patientId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, doctorId])
  @@index([userId])
}

// notification
model DeviceToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform  String? // e.g., "android", "ios", "web"
  createdAt DateTime @default(now())

  @@index([userId])
}
